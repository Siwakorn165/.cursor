"use strict";var __awaiter=this&&this.__awaiter||function(e,r,o,t){return new(o||(o=Promise))((function(n,s){function c(e){try{a(t.next(e))}catch(e){s(e)}}function i(e){try{a(t.throw(e))}catch(e){s(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(c,i)}a((t=t.apply(e,r||[])).next())}))},__generator=this&&this.__generator||function(e,r){var o,t,n,s,c={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(i){return function(a){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;s&&(s=0,i[0]&&(c=0)),c;)try{if(o=1,t&&(n=2&i[0]?t.return:i[0]?t.throw||((n=t.return)&&n.call(t),0):t.next)&&!(n=n.call(t,i[1])).done)return n;switch(t=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,t=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!((n=(n=c.trys).length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){c=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){c.label=i[1];break}if(6===i[0]&&c.label<n[1]){c.label=n[1],n=i;break}if(n&&c.label<n[2]){c.label=n[2],c.ops.push(i);break}n[2]&&c.ops.pop(),c.trys.pop();continue}i=r.call(e,c)}catch(e){i=[6,e],t=0}finally{o=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(exports,"__esModule",{value:!0});var child_process_1=require("child_process"),net=require("net"),util_1=require("util"),execFileAsync=(0,util_1.promisify)(child_process_1.execFile);function logInfo(e){console.info("forwarder: ".concat(e))}function logError(e){console.error("forwarder error: ".concat(e))}var Forwarder=function(){function e(e){this.kubectlPath=e}return e.prototype.monitorContainer=function(e){var r;return __awaiter(this,void 0,void 0,(function(){var o,t,n;return __generator(this,(function(s){switch(s.label){case 0:s.label=1;case 1:return s.trys.push([1,3,,4]),[4,execFileAsync(this.kubectlPath,["get","pod","--namespace",e.namespace,"--context",e.context,"-o","json",e.podname],{windowsHide:!0})];case 2:return o=s.sent().stdout,t=JSON.parse(o),"Running"===(null===(r=null==t?void 0:t.status)||void 0===r?void 0:r.phase)?[3,4]:(logInfo("Pod not alive: ".concat(JSON.stringify(t))),[3,6]);case 3:return n=s.sent(),logError("Error checking pod status: ".concat(n)),[3,6];case 4:return[4,new Promise((function(e){return setTimeout(e,1e3)}))];case 5:return s.sent(),[3,0];case 6:return[2]}}))}))},e.prototype.generateRemoteNodeJsCode=function(e){if(void 0!==e.port&&void 0!==e.hostname)return"\nconst net = require('net');\nconst fs = require('fs');\nprocess.stdin.pause();\nconst client = net.createConnection({ host: '".concat(e.hostname,"', port: ").concat(e.port,"}, () => {\n\tconsole.error('Connection established');\n\tclient.pipe(process.stdout);\n\tprocess.stdin.pipe(client);\n});\nclient.on('close', function (hadError) {\n\tconsole.error(hadError ? 'Remote close with error' : 'Remote close');\n\tprocess.exit(hadError ? 1 : 0);\n});\nclient.on('error', function (err) {\n\tprocess.stderr.write(err && (err.stack || err.message) || String(err));\n});\nprocess.stdin.on('close', function (hadError) {\n\tconsole.error(hadError ? 'Remote stdin close with error' : 'Remote stdin close');\n\tprocess.exit(hadError ? 1 : 0);\n});\nprocess.on('uncaughtException', function (err) {\n\tfs.writeSync(process.stderr.fd, 'error: ' + (err.stack || err.message) + '\\n');\n\tprocess.exit(1);\n});");if(void 0!==e.socket)return"\nconst net = require('net');\nconst fs = require('fs');\nprocess.stdin.pause();\nconst server = net.createServer(function (socket) {\n\tconsole.error('Connection established');\n\tsocket.pipe(process.stdout);\n\tprocess.stdin.pipe(socket);\n});\nserver.listen({ path: '".concat(e.socket,"'});\nserver.on('close', function (hadError) {\n\tconsole.error(hadError ? 'Remote close with error' : 'Remote close');\n\tprocess.exit(hadError ? 1 : 0);\n});\nserver.on('error', function (err) {\n\tprocess.stderr.write(err && (err.stack || err.message) || String(err));\n});\nprocess.stdin.on('close', function (hadError) {\n\tconsole.error(hadError ? 'Remote stdin close with error' : 'Remote stdin close');\n\tprocess.exit(hadError ? 1 : 0);\n});\nprocess.on('uncaughtException', function (err) {\n\tfs.writeSync(process.stderr.fd, 'error: ' + (err.stack || err.message) + '\\n');\n\tprocess.exit(1);\n});\n");throw new Error("Invalid arguments, exactly one of socket or port must be provided.")},e.prototype.handleClient=function(e){var r=e.socket,o=e.podConfig,t=e.options,n=e.remoteServerNodePath,s=this.generateRemoteNodeJsCode(t),c="".concat(n,' -e "').concat(s,'"'),i=[this.kubectlPath,"exec","--namespace",o.namespace,"--context",o.context,"-i","-c",o.name,o.podname,"--","bash","-c",c],a=(0,child_process_1.spawn)(i[0],i.slice(1),{stdio:["pipe","pipe","pipe"]});return r.pipe(a.stdin),a.stdout.pipe(r),new Promise((function(e,o){r.on("close",(function(){a.kill(),e()})),r.on("error",(function(e){logError("handleClient error: ".concat(e.message)),a.kill(),o(e)})),a.on("error",(function(e){logError("handleClient error: ".concat(e.message)),r.end(),o(e)})),a.on("close",(function(){logInfo("handleClient subprocess closed"),r.end(),e()})),a.on("exit",(function(t,n){logInfo("handleClient subprocess exited with code ".concat(t," and signal ").concat(n)),r.end(),0!==t?o(new Error("handleClient subprocess exited with code ".concat(t," and signal ").concat(n))):e()}))}))},e.prototype.startServer=function(e){var r=this,o=e.podConfig,t=e.localHostname,n=e.localPort,s=e.remoteHostname,c=e.remotePort,i=e.remoteServerNodePath,a=net.createServer((function(e){r.handleClient({socket:e,podConfig:o,options:{port:c,hostname:s},remoteServerNodePath:i}).catch((function(r){logError("startServer error: ".concat(r instanceof Error?r.message:String(r))),e.end()}))}));return new Promise((function(e,s){a.on("listening",(function(){var t=a.address();logInfo("====forwarderPort=".concat(t.port,"====")),r.monitorContainer(o).then((function(){a.close(),logInfo("Stopping forwarding for port ".concat(t.port)),e()})).catch(s)})),a.on("error",(function(e){s(e)})),a.listen(n,t)}))},e.prototype.startSocketForward=function(e,r,o,t){return __awaiter(this,void 0,void 0,(function(){var n,s,c;return __generator(this,(function(i){switch(i.label){case 0:n=net.createConnection(r),s=this.handleClient({socket:n,podConfig:e,options:{socket:o},remoteServerNodePath:t}),logInfo("====socketForward=success===="),i.label=1;case 1:return i.trys.push([1,3,4,5]),[4,Promise.race([s,this.monitorContainer(e)])];case 2:return i.sent(),[3,5];case 3:throw c=i.sent(),logError("socketForward error: ".concat(c instanceof Error?c.message:String(c))),c;case 4:return n.end(),[7];case 5:return logInfo("Stopping forwarding for socket ".concat(r," to ").concat(o)),[2]}}))}))},e.prototype.forwardPort=function(e){var r=e.podConfig,o=e.localHostname,t=e.localPort,n=e.remoteHostname,s=e.remotePort,c=e.remoteServerNodePath;return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,this.startServer({podConfig:r,localHostname:o,localPort:t,remoteHostname:n,remotePort:s,remoteServerNodePath:c})];case 1:return e.sent(),[2]}}))}))},e.prototype.forwardSocket=function(e,r,o,t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this.startSocketForward(e,r,o,t)];case 1:return n.sent(),[2]}}))}))},e}();function main(){var e;return __awaiter(this,void 0,void 0,(function(){var r,o,t,n,s,c,i,a,l,u,d,p,f;return __generator(this,(function(h){switch(h.label){case 0:return 8!==(r=process.argv.slice(2)).length&&(logError('Expected arguments: "port"|"socket" <context> <namespace> <podname> <containername> <remote_server_node_path> (<local_host> <remote_host> | <local_socket> <remote_socket>)'),process.exit(1)),"port"!==(o=r[0])&&"socket"!==o&&(logError('Expected arguments: "port"|"socket" <context> <namespace> <podname> <containername> <remote_server_node_path> (<local_host> <remote_host>  | <local_socket> <remote_socket>)'),process.exit(1)),logInfo("Forwarder started with args ".concat(r.join(" "))),t=null!==(e=process.env.KUBECTL_PATH)&&void 0!==e?e:"kubectl",n={context:r[1],namespace:r[2],podname:r[3],name:r[4]},s=r[5],process.stdin.on("data",(function(e){e.includes("\0")&&(logInfo("Received null character, exiting"),process.exit(0))})),process.stdin.on("close",(function(){logInfo("stdin closed"),process.exit(1)})),process.stdin.on("error",(function(e){logError("stdin error: ".concat(e)),process.exit(1)})),process.stdin.resume(),"port"!==o?[3,2]:(c=r[6],i=c.split(":")[0],a=parseInt(c.split(":")[1]),l=r[7],u=l.split(":")[0],d=parseInt(l.split(":")[1]),logInfo("Forwarding remote ".concat(u,":").concat(d," to local ").concat(i,":").concat(a," for container ").concat(n.podname)),[4,new Forwarder(t).forwardPort({podConfig:n,localHostname:i,localPort:a,remoteHostname:u,remotePort:d,remoteServerNodePath:s})]);case 1:return h.sent(),[3,4];case 2:return"socket"!==o?[3,4]:(p=r[6],f=r[7],[4,new Forwarder(t).forwardSocket(n,p,f,s)]);case 3:h.sent(),h.label=4;case 4:return[2]}}))}))}main().then((function(){logInfo("Forwarder exiting"),process.exit(0)})).catch((function(e){logError(String(e)),process.exit(1)}));