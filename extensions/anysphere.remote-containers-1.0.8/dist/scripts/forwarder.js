"use strict";var __awaiter=this&&this.__awaiter||function(e,r,o,t){return new(o||(o=Promise))((function(n,s){function c(e){try{a(t.next(e))}catch(e){s(e)}}function i(e){try{a(t.throw(e))}catch(e){s(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(c,i)}a((t=t.apply(e,r||[])).next())}))},__generator=this&&this.__generator||function(e,r){var o,t,n,s,c={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(i){return function(a){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;s&&(s=0,i[0]&&(c=0)),c;)try{if(o=1,t&&(n=2&i[0]?t.return:i[0]?t.throw||((n=t.return)&&n.call(t),0):t.next)&&!(n=n.call(t,i[1])).done)return n;switch(t=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,t=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!((n=(n=c.trys).length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){c=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){c.label=i[1];break}if(6===i[0]&&c.label<n[1]){c.label=n[1],n=i;break}if(n&&c.label<n[2]){c.label=n[2],c.ops.push(i);break}n[2]&&c.ops.pop(),c.trys.pop();continue}i=r.call(e,c)}catch(e){i=[6,e],t=0}finally{o=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(exports,"__esModule",{value:!0});var child_process_1=require("child_process"),net=require("net");function logInfo(e){console.info("forwarder: ".concat(e))}function logError(e){console.error("forwarder error: ".concat(e))}var Forwarder=function(){function e(e){this.dockerPath=e}return e.prototype.monitorContainer=function(e,r){return __awaiter(this,void 0,void 0,(function(){var o,t,n,s,c;return __generator(this,(function(i){switch(i.label){case 0:o=0,t=Date.now(),n=function(){var n;return __generator(this,(function(c){switch(c.label){case 0:return n=(0,child_process_1.spawn)(s.dockerPath,["exec","-u",r,"-i",e,"tail","-f","/dev/null"]),[4,new Promise((function(e){n.on("error",(function(r){e()})),n.once("close",(function(){e()})),n.on("exit",(function(){e()}))}))];case 1:return c.sent(),Date.now()-t>3e4&&(o=0,t=Date.now()),++o>3?(logError("Too many retries in 30 seconds, assuming container is actually dead"),[2,{value:void 0}]):[2]}}))},s=this,i.label=1;case 1:return[5,n()];case 2:return"object"==typeof(c=i.sent())?[2,c.value]:[3,1];case 3:return[2]}}))}))},e.prototype.generateRemoteNodeJsCode=function(e){if(void 0!==e.port&&void 0!==e.hostname)return"\nconst net = require('net');\nconst fs = require('fs');\nprocess.stdin.pause();\nconst client = net.createConnection({ host: '".concat(e.hostname,"', port: ").concat(e.port,"}, () => {\n\tconsole.error('Connection established');\n\tclient.pipe(process.stdout);\n\tprocess.stdin.pipe(client);\n});\nclient.on('close', function (hadError) {\n\tconsole.error(hadError ? 'Remote close with error' : 'Remote close');\n\tprocess.exit(hadError ? 1 : 0);\n});\nclient.on('error', function (err) {\n\tprocess.stderr.write(err && (err.stack || err.message) || String(err));\n});\nprocess.stdin.on('close', function (hadError) {\n\tconsole.error(hadError ? 'Remote stdin close with error' : 'Remote stdin close');\n\tprocess.exit(hadError ? 1 : 0);\n});\nprocess.on('uncaughtException', function (err) {\n\tfs.writeSync(process.stderr.fd, 'error: ' + (err.stack || err.message) + '\\n');\n\tprocess.exit(1);\n});");if(void 0!==e.socket)return"\nconst net = require('net');\nconst fs = require('fs');\nprocess.stdin.pause();\nconst server = net.createServer(function (socket) {\n\tconsole.error('Connection established');\n\tsocket.pipe(process.stdout);\n\tprocess.stdin.pipe(socket);\n});\nserver.listen({ path: '".concat(e.socket,"'});\nserver.on('close', function (hadError) {\n\tconsole.error(hadError ? 'Remote close with error' : 'Remote close');\n\tprocess.exit(hadError ? 1 : 0);\n});\nserver.on('error', function (err) {\n\tprocess.stderr.write(err && (err.stack || err.message) || String(err));\n});\nprocess.stdin.on('close', function (hadError) {\n\tconsole.error(hadError ? 'Remote stdin close with error' : 'Remote stdin close');\n\tprocess.exit(hadError ? 1 : 0);\n});\nprocess.on('uncaughtException', function (err) {\n\tfs.writeSync(process.stderr.fd, 'error: ' + (err.stack || err.message) + '\\n');\n\tprocess.exit(1);\n});\n");throw new Error("Invalid arguments, exactly one of socket or port must be provided.")},e.prototype.handleClient=function(e){var r=e.socket,o=e.containerId,t=e.options,n=e.remoteServerNodePath,s=e.remoteUser,c=this.generateRemoteNodeJsCode(t),i="".concat(n,' -e "').concat(c,'"'),a=[this.dockerPath,"exec","-u",s,"-i",o,"bash","-c",i],l=(0,child_process_1.spawn)(a[0],a.slice(1),{stdio:["pipe","pipe","pipe"]});return r.pipe(l.stdin),l.stdout.pipe(r),new Promise((function(e,o){r.on("close",(function(){l.kill(),e()})),r.on("error",(function(e){logError("handleClient error: ".concat(e.message)),l.kill(),o(e)})),l.on("error",(function(e){logError("handleClient error: ".concat(e.message)),r.end(),o(e)})),l.on("close",(function(){logInfo("handleClient subprocess closed"),r.end(),e()})),l.on("exit",(function(t,n){logInfo("handleClient subprocess exited with code ".concat(t," and signal ").concat(n)),r.end(),0!==t?o(new Error("handleClient subprocess exited with code ".concat(t," and signal ").concat(n))):e()}))}))},e.prototype.startServer=function(e){var r=this,o=e.containerId,t=e.localPort,n=e.localHostname,s=e.remotePort,c=e.remoteHostname,i=e.remoteServerNodePath,a=e.remoteUser,l=net.createServer((function(e){r.handleClient({socket:e,containerId:o,options:{port:s,hostname:c},remoteServerNodePath:i,remoteUser:a}).catch((function(r){e.end(),logError("startServer error: ".concat(r instanceof Error?r.message:String(r)))}))}));return new Promise((function(e,s){l.on("listening",(function(){var t=l.address().port;logInfo("====forwarderPort=".concat(t,"====")),r.monitorContainer(o,a).then((function(){l.close(),logInfo("Stopping forwarding for port ".concat(t)),e()})).catch(s)})),l.on("error",(function(e){s(e)})),l.listen(t,n)}))},e.prototype.startSocketForward=function(e,r,o,t,n){return __awaiter(this,void 0,void 0,(function(){var s,c,i;return __generator(this,(function(a){switch(a.label){case 0:s=net.createConnection(r),c=this.handleClient({socket:s,containerId:e,options:{socket:o},remoteServerNodePath:t,remoteUser:n}),logInfo("====socketForward=success===="),a.label=1;case 1:return a.trys.push([1,3,4,5]),[4,c];case 2:return a.sent(),[3,5];case 3:throw i=a.sent(),logError("socketForward error: ".concat(i instanceof Error?i.message:String(i))),i;case 4:return s.end(),[7];case 5:return logInfo("Stopping forwarding for socket ".concat(r," to ").concat(o," ")),[2]}}))}))},e.prototype.forwardPort=function(e){var r=e.containerId,o=e.localPort,t=e.localHostname,n=e.remotePort,s=e.remoteHostname,c=e.remoteServerNodePath,i=e.remoteUser;return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,this.startServer({containerId:r,localPort:o,localHostname:t,remotePort:n,remoteHostname:s,remoteServerNodePath:c,remoteUser:i})];case 1:return e.sent(),[2]}}))}))},e.prototype.forwardSocket=function(e,r,o,t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(s){switch(s.label){case 0:return[4,this.startSocketForward(e,r,o,t,n)];case 1:return s.sent(),[2]}}))}))},e}();function main(){var e;return __awaiter(this,void 0,void 0,(function(){var r,o,t,n,s,c,i,a,l,u,d,p,f,h;return __generator(this,(function(m){switch(m.label){case 0:return 6!==(r=process.argv.slice(2)).length&&(logError('Expected arguments: "port"|"socket" <container_id> <remote_server_node_path> <remoteUser> (<local_host> <remote_host> | <local_socket> <remote_socket>)'),process.exit(1)),"port"!==(o=r[0])&&"socket"!==o&&(logError('Expected arguments: "port"|"socket" <container_id> <remote_server_node_path> <remoteUser> (<local_host> <remote_host> | <local_socket> <remote_socket>)'),process.exit(1)),t=r[1],n=r[2],s=r[3],c=null!==(e=process.env.DOCKER_PATH)&&void 0!==e?e:"docker",process.stdin.on("data",(function(e){e.includes("\0")&&(logInfo("Received null character, exiting"),process.exit(0))})),process.stdin.on("close",(function(){logInfo("stdin closed"),process.exit(1)})),process.stdin.on("error",(function(e){logError("stdin error: ".concat(e)),process.exit(1)})),process.stdin.resume(),"port"!==o?[3,2]:(i=r[4],a=i.split(":")[0],l=parseInt(i.split(":")[1]),u=r[5],d=u.split(":")[0],p=parseInt(u.split(":")[1]),logInfo("Forwarding (remote) ".concat(d,":").concat(p," to (local) ").concat(a,":").concat(l," for container ").concat(t)),[4,new Forwarder(c).forwardPort({containerId:t,localPort:l,localHostname:a,remotePort:p,remoteHostname:d,remoteServerNodePath:n,remoteUser:s})]);case 1:return m.sent(),[3,4];case 2:return"socket"!==o?[3,4]:(f=r[4],h=r[5],[4,new Forwarder(c).forwardSocket(t,f,h,n,s)]);case 3:m.sent(),m.label=4;case 4:return[2]}}))}))}main().then((function(){logInfo("Forwarder exiting"),process.exit(0)})).catch((function(e){logError(String(e)),process.exit(1)}));